blueprint:
  name: Present Light
  description: Turn a light/plug on and off based on detected presents/motion.
  domain: automation
  input:
    occupied_binary_sensor:
      name: Occupied Sensor
      description: Sensor that indicates if the room is occupied.
      selector:
        entity:
          filter:
            - domain: binary_sensor
    additional_trigger:
      name: Additional Trigger
      description: Additional Triggers can be configured here. For example checking a light sensor.
      default:
      selector:
        trigger:
    condition_on:
      name: Condition On
      description: Additional conditions for turning on the devices.
      default: [ ]
      selector:
        condition:
    condition_off:
      name: Condition Off
      description: Additional conditions for turning off the devices.
      default: [ ]
      selector:
        condition:
    no_occupancy_wait:
      name: Wait time
      description: Wait time for turning off the light/switch.
      default: 0
      selector:
        number:
          min: 0
          max: 300
          unit_of_measurement: seconds
    light_target:
      name: Light Target
      description: Light that should be turned on/off.
      default: { }
      selector:
        target:
          entity:
            domain: light
    switch_target:
      name: Switch Target
      description: Switch that should be turned on/off.
      default: { }
      selector:
        target:
          entity:
            domain: switch
    additional_action_condition:
      name: Additional Action Condition
      description: Conditions for additional turn on of devices.
      default: [ ]
      selector:
        condition:
    additional_light_target:
      name: Additional Light Target
      description: Light that should be turned on/off additionally.
      default: { }
      selector:
        target:
          entity:
            domain: light
    additional_switch_target:
      name: Additional Switch Target
      description: Switch that should be turned on/off additionally.
      default: { }
      selector:
        target:
          entity:
            domain: switch

mode: restart

triggers:
  - trigger: state
    entity_id: !input occupied_binary_sensor
  - triggers: !input additional_trigger

actions:
  - choose:
      - conditions:
          - condition: state
            entity_id: !input occupied_binary_sensor
            state: "on"
          - condition: and
            conditions: !input condition_on
        sequence:
          - if:
              - condition: !input additional_action_condition
            then:
              - action: switch.turn_on
                target: !input additional_switch_target
              - action: light.turn_on
                target: !input additional_light_target
          - action: switch.turn_on
            target: !input switch_target
          - action: light.turn_on
            target: !input light_target
      - conditions:
          - condition: or
            conditions:
              - condition: state
                entity_id: !input occupied_binary_sensor
                state: "off"
              - condition: or
                conditions: !input condition_off
        sequence:
          - delay: !input no_occupancy_wait
          - action: switch.turn_off
            target: !input switch_target
          - action: light.turn_off
            target: !input light_target
          - action: switch.turn_off
            target: !input additional_switch_target
          - action: light.turn_off
            target: !input additional_light_target
